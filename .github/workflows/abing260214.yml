name: Auto Update BPB Panel to Latest

on:
  schedule:
    - cron: '15 3 * * *'          # 每天 UTC 3:15（北京/新加坡时间上午11:15），避开高峰
  workflow_dispatch:              # 支持手动触发
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/update-bpb.yml'  # 只在修改本文件时触发，避免无关 push

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}   # 必须用 GITHUB_TOKEN 才有 push 权限

      - name: Get latest release tag
        id: get_version
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latest | jq -r .tag_name)
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "Latest BPB version: $LATEST_TAG"

      - name: Check if already up-to-date
        id: check_update
        run: |
          if [ -f "current_version.txt" ]; then
            CURRENT=$(cat current_version.txt)
            if [ "\( CURRENT" = " \){{ env.LATEST_TAG }}" ]; then
              echo "Already latest version ${{ env.LATEST_TAG }} - skipping update"
              echo "skip=true" >> $GITHUB_OUTPUT
            else
              echo "New version available: ${{ env.LATEST_TAG }}"
              echo "skip=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No previous version record - proceeding"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Download latest worker.zip (if needed)
        if: steps.check_update.outputs.skip != 'true'
        run: |
          curl -L -o worker.zip https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/latest/download/worker.zip
          ls -lh worker.zip

      - name: Extract and clean
        if: steps.check_update.outputs.skip != 'true'
        run: |
          rm -rf extracted
          mkdir extracted
          unzip -o worker.zip -d extracted
          # 移动关键文件到根目录（Pages 期望 _worker.js 在根）
          find extracted -type f \( -name "_worker.js" -o -name "index.html" -o -name "*.js" -o -name "*.css" -o -name "*.html" \) -exec mv {} . \;
          # 可选：删除不必要的文件/文件夹（视情况）
          rm -rf extracted worker.zip
          # 保存版本号用于下次比较
          echo "${{ env.LATEST_TAG }}" > current_version.txt

      - name: Commit and push changes (only if updated)
        if: steps.check_update.outputs.skip != 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-update BPB Panel to ${{ env.LATEST_TAG }}"
          file_pattern: .
          branch: main
          skip_dirty_check: false
          skip_fetch: true
          skip_checkout: true

      - name: Log result
        run: |
          if [ "${{ steps.check_update.outputs.skip }}" = "true" ]; then
            echo "No update needed."
          else
            echo "Updated to ${{ env.LATEST_TAG }} and committed."
          fi
