name: Auto Update BPB Panel to Latest

on:
  schedule:
    - cron: '15 3 * * *'          # 每天 UTC 3:15（北京/新加坡时间上午11:15），避开高峰
  workflow_dispatch:              # 支持手动触发
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/update-bpb.yml'  # 只在修改本文件时触发，避免无关 push

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}   # 必须用 GITHUB_TOKEN 才有 push 权限

      - name: Get latest release tag
        id: get_version
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latest | jq -r .tag_name)
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "Latest BPB version: $LATEST_TAG"

      - name: Check if already up-to-date
        id: check_update
        run: |
          if [ -f "current_version.txt" ]; then
            CURRENT=$(cat current_version.txt)
            if [ "$CURRENT" = "$LATEST_TAG" ]; then
              echo "Already latest version $LATEST_TAG - skipping update"
              echo "skip=true" >> $GITHUB_OUTPUT
            else
              echo "New version available: $LATEST_TAG"
              echo "skip=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No previous version record - proceeding"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Download latest worker.zip (if needed)
        if: steps.check_update.outputs.skip != 'true'
        run: |
          curl -L -o worker.zip https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/latest/download/worker.zip
          ls -lh worker.zip

      - name: Extract and clean
        if: steps.check_update.outputs.skip != 'true'
        run: |
          rm -rf extracted
          mkdir extracted
          unzip -o worker.zip -d extracted
          
          # 创建备份并安全移动文件
          # 只移动 worker.js 相关文件，避免覆盖其他重要文件
          if [ -f "extracted/_worker.js" ]; then
            cp extracted/_worker.js .
          fi
          
          # 如果有其他特定文件需要更新
          for file in extracted/*.html extracted/*.js extracted/*.css; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              cp "$file" "./$filename"
            fi
          done
          
          # 清理临时文件
          rm -rf extracted worker.zip
          
          # 保存版本号用于下次比较
          echo "$LATEST_TAG" > current_version.txt

      - name: Commit and push changes (only if updated)
        if: steps.check_update.outputs.skip != 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-update BPB Panel to ${{ env.LATEST_TAG }}"
          file_pattern: |
            *.js
            *.html
            *.css
            current_version.txt
          branch: main
          skip_dirty_check: false
          skip_fetch: true
          skip_checkout: true

      - name: Log result
        run: |
          if [ "${{ steps.check_update.outputs.skip }}" = "true" ]; then
            echo "No update needed."
          else
            echo "Updated to ${{ env.LATEST_TAG }} and committed."
          fi
