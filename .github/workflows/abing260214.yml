name: Auto Update BPB Panel to Latest

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 03:15 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 11:15ï¼‰
    - cron: '15 3 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å½“æ›´æ–°æœ¬å·¥ä½œæµæ–‡ä»¶æ—¶ä¹Ÿè§¦å‘
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/update-bpb.yml'

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      # æ­¥éª¤ 2: è®¾ç½® Git èº«ä»½ä¿¡æ¯ï¼ˆç”¨äºåç»­æäº¤ï¼‰
      - name: Setup Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # æ­¥éª¤ 3: è·å–æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾
      - name: Get latest release tag
        id: get_version
        run: |
          # ä½¿ç”¨ GitHub API è·å–æœ€æ–°å‘å¸ƒç‰ˆæœ¬
          LATEST_TAG=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latest \
            | grep '"tag_name"' | cut -d '"' -f 4)
          
          if [ -z "$LATEST_TAG" ]; then
            echo "âŒ Failed to get latest tag"
            exit 1
          fi
          
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "Latest BPB version: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 4: æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
      - name: Check if already up-to-date
        id: check_update
        run: |
          # æ£€æŸ¥å½“å‰ç‰ˆæœ¬è®°å½•æ–‡ä»¶
          if [ -f "current_version.txt" ]; then
            CURRENT_VERSION=$(cat current_version.txt)
            echo "Current version: $CURRENT_VERSION"
            echo "Latest version: $LATEST_TAG"
            
            if [ "$CURRENT_VERSION" = "$LATEST_TAG" ]; then
              echo "âœ… Already at latest version ($LATEST_TAG)"
              echo "skip_update=true" >> $GITHUB_OUTPUT
              echo "update_needed=false" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "ğŸ“¦ Update available: $CURRENT_VERSION -> $LATEST_TAG"
              echo "skip_update=false" >> $GITHUB_OUTPUT
              echo "update_needed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸ“ No version record found. First-time setup."
            echo "skip_update=false" >> $GITHUB_OUTPUT
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤ 5: ä¸‹è½½æœ€æ–°å‘å¸ƒåŒ…
      - name: Download latest release
        if: steps.check_update.outputs.skip_update == 'false'
        run: |
          echo "Downloading worker.zip from release $LATEST_TAG..."
          
          # ä¸‹è½½ worker.zip
          curl -s -L -o worker.zip \
            "https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/download/$LATEST_TAG/worker.zip"
          
          # éªŒè¯ä¸‹è½½æ˜¯å¦æˆåŠŸ
          if [ ! -f "worker.zip" ]; then
            echo "âŒ Failed to download worker.zip"
            exit 1
          fi
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          FILE_SIZE=$(ls -lh worker.zip | awk '{print $5}')
          echo "âœ… Downloaded worker.zip ($FILE_SIZE)"

      # æ­¥éª¤ 6: æå–å¹¶éƒ¨ç½²æ–‡ä»¶
      - name: Extract and deploy
        if: steps.check_update.outputs.skip_update == 'false'
        run: |
          echo "Extracting worker.zip..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          EXTRACT_DIR="bpb_extracted_$(date +%s)"
          mkdir -p "$EXTRACT_DIR"
          
          # è§£å‹æ–‡ä»¶
          if ! unzip -q worker.zip -d "$EXTRACT_DIR"; then
            echo "âŒ Failed to extract worker.zip"
            exit 1
          fi
          
          echo "Contents of extracted directory:"
          find "$EXTRACT_DIR" -type f | head -20
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶æ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
          echo "Copying files to repository root..."
          
          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼ˆä¿æŒç›®å½•ç»“æ„ï¼‰
          if [ -d "$EXTRACT_DIR" ]; then
            # ä½¿ç”¨ rsync å¤åˆ¶æ–‡ä»¶ï¼Œä¿ç•™ç›®å½•ç»“æ„
            if command -v rsync &> /dev/null; then
              rsync -av "$EXTRACT_DIR"/ ./
            else
              cp -r "$EXTRACT_DIR"/* ./
            fi
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf "$EXTRACT_DIR" worker.zip
          
          # ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
          echo "$LATEST_TAG" > current_version.txt
          
          # åˆ—å‡ºæ›´æ–°çš„æ–‡ä»¶
          echo "âœ… Updated files:"
          git status --porcelain || true

      # æ­¥éª¤ 7: æäº¤æ›´æ”¹
      - name: Commit changes
        if: steps.check_update.outputs.skip_update == 'false'
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet && git diff --cached --quiet; then
            echo "âš ï¸ No changes to commit"
            exit 0
          fi
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
          git add .
          
          # æäº¤æ›´æ”¹
          git commit -m "ğŸ”§ chore: auto-update BPB Panel to $LATEST_TAG [skip ci]"
          
          # æ¨é€æ›´æ”¹
          echo "Pushing changes to main branch..."
          git push origin main

      # æ­¥éª¤ 8: æ›´æ–°ç»“æœæ€»ç»“
      - name: Update summary
        run: |
          if [ "${{ steps.check_update.outputs.skip_update }}" = "true" ]; then
            echo "ğŸ“Š **Summary:** No update needed."
            echo "âœ… Already at latest version: $LATEST_TAG"
          else
            echo "ğŸ“Š **Summary:** Update completed successfully!"
            echo "âœ… Updated from: ${{ steps.check_update.outputs.current_version || 'N/A' }}"
            echo "âœ… Updated to: $LATEST_TAG"
            echo "âœ… Changes committed and pushed to main branch"
          fi
          
          echo "ğŸ•’ Next auto-update: UTC 03:15 daily"
